# Предложения по улучшению инструмента Codex для MultiCode

## Контекст
Ниже — список практичных улучшений с фокусом на стабильность, предсказуемость и снижение нагрузки на ревью.

## Старт реализации (выполнено в текущей итерации)
- [x] **Пункт 1: Единый реестр кодов ошибок**
  - Добавлен `include/visprog/core/ErrorCodes.hpp`.
  - `Graph.cpp` и `GraphSerializer.cpp` переведены на единые коды.
  - Тесты `test_graph.cpp` и `test_graph_serializer.cpp` используют коды из реестра вместо локальных чисел.
- [x] **Пункт 6 (частично): контрактные комментарии для сложных функций**
  - Добавлены контрактные комментарии над `Graph::validate()` и `Graph::remove_node_connections()`.

## 1) Единый реестр кодов ошибок ядра
- Вынести коды ошибок Graph/Node/Serializer в общий заголовок (например, `ErrorCodes.hpp`).
- Добавить короткую таблицу соответствия: код → смысл → модуль.
- Эффект: меньше рассинхронизации между тестами и реализацией.

## 2) “Строгий режим инвариантов” для `Graph::validate()`
- Добавить флаг режима валидации: `Basic`/`Strict`.
- В `Strict` проверять дополнительные инварианты (например, циклы execution-flow, если это требование домена).
- Эффект: гибкость между production-путём и диагностикой в CI.

## 3) Property-based тесты для графа
- Генерировать случайные графы (ограниченные по размеру) и проверять инварианты после серии операций.
- Сценарии: add/remove/connect/disconnect в случайном порядке.
- Эффект: лучшее покрытие edge-case сценариев, которые трудно придумать вручную.

## 4) Снимки (snapshot) внутренних структур графа для отладки
- Добавить диагностическую сериализацию состояния `connections_`, `connection_lookup_`, `adjacency_*`.
- Применять только в тестах или debug-сборке.
- Эффект: ускоряет поиск причин рассинхронизации индексов.

## 5) Метрики качества валидации в CI
- Отчёт по типам найденных ошибок в тестах: broken refs, lookup mismatch, type mismatch.
- Тренд по времени (сколько и каких падений ловится).
- Эффект: видимость деградаций, которые иначе «тонут» в логах.

## 6) Контракты сложных функций в комментариях (по шаблону проекта)
- Для `validate`, `remove_node_connections`, `disconnect` явно фиксировать инварианты и риски.
- Использовать маркеры `INVARIANT:` и `DANGER:` рядом с чувствительными местами.
- Эффект: проще безопасно рефакторить без повторных регрессий.

## 7) Проверка консистентности тестового покрытия по модулям
- Явная матрица: публичный API → тест-кейсы.
- Минимальный порог для критичных модулей (Graph/Serializer).
- Эффект: меньше “слепых зон”, особенно при архитектурных изменениях.

## 8) Автоматическая валидация стиля и сборки перед PR
- Локальный pre-push hook: `clang-format`, сборка, `ctest`.
- Для webview части — аналогичный минимальный набор (`npm run compile`, `npm run lint`, `npm test`).
- Эффект: меньше итераций на исправление базовых ошибок после ревью.

## 9) Набор негативных тестов на “неправильные” данные сериализации
- Дополнить кейсами частично повреждённых JSON-документов и конфликтов типов портов.
- Проверять не только факт ошибки, но и стабильность/понятность диагностики.
- Эффект: надёжнее импорт и миграции графов между версиями.

## 10) Явная политика обратной совместимости формата графа
- Документировать, что считается breaking change.
- Для breaking-изменений — мигратор или dual-read стратегия.
- Эффект: меньше рисков повреждения пользовательских проектов при обновлении.

---

Если нужна, могу следующим шагом превратить этот список в пошаговый roadmap с приоритизацией (P0/P1/P2) и оценкой трудозатрат.
