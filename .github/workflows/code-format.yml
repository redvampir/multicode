name: Code Format Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  clang-format:
    name: Check C++ Code Formatting
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Prepare clang-format
      run: |
        set -euo pipefail
        if command -v clang-format >/dev/null 2>&1; then
          echo "clang-format already available"
          clang-format --version
          exit 0
        fi

        # Fallback для редких self-hosted runner без clang-format.
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends clang-format
        clang-format --version

    - name: Check formatting
      run: |
        set -euo pipefail
        clang-format --version

        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          BASE_REF="origin/${{ github.base_ref }}"
          git fetch --no-tags --depth=1 origin "${{ github.base_ref }}"
          RANGE="${BASE_REF}...HEAD"
        else
          RANGE="${{ github.event.before }}...${{ github.sha }}"
        fi

        mapfile -t CPP_FILES < <(git diff --name-only "${RANGE}" | \
          rg '^(src|include|tests)/.*\.(cpp|hpp)$')

        if [[ ${#CPP_FILES[@]} -eq 0 ]]; then
          echo "Нет изменённых C++ файлов для формат-проверки."
          exit 0
        fi

        printf '%s\n' "${CPP_FILES[@]}" | xargs clang-format --dry-run --Werror

    - name: Suggest fixes (on failure)
      if: failure()
      run: |
        echo "::warning::Code formatting issues detected!"
        echo "Run 'find src include tests \( -name '*.cpp' -o -name '*.hpp' \) -print0 | xargs -0 clang-format -i' to fix"
