name: C++ CI Smoke

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'CMakeLists.txt'
      - 'include/**'
      - 'src/**'
      - 'tests/**'
      - 'vcpkg.json'
      - '.github/workflows/ci.yml'
      - '.github/workflows/cpp-build.yml'
  push:
    branches: [main, develop]
    paths:
      - 'CMakeLists.txt'
      - 'include/**'
      - 'src/**'
      - 'tests/**'
      - 'vcpkg.json'
      - '.github/workflows/ci.yml'
      - '.github/workflows/cpp-build.yml'

concurrency:
  group: cpp-ci-smoke-${{ github.ref }}
  cancel-in-progress: true

env:
  BUILD_TYPE: Release
  CXX_COMPILER: g++-12
  CMAKE_GENERATOR: Ninja
  VCPKG_COMMIT_ID: 10b7a178346f3f0abef60cecd5130e295afd8da4

jobs:
  smoke-build-linux:
    name: Linux smoke (configure + build)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build ${{ env.CXX_COMPILER }}

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11.5
        with:
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT_ID }}

      - name: Configure CMake
        run: |
          cmake -B build -S . \
            -G "${{ env.CMAKE_GENERATOR }}" \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_CXX_COMPILER=${{ env.CXX_COMPILER }} \
            -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }}

      - name: Test
        run: ctest --test-dir build --output-on-failure --verbose --progress

      - name: Debug CTest failure log
        if: failure()
        run: |
          echo "CTest failed. Showing build/Testing/Temporary/LastTest.log (if present):"
          if [ -f build/Testing/Temporary/LastTest.log ]; then
            cat build/Testing/Temporary/LastTest.log
          else
            echo "LastTest.log not found at build/Testing/Temporary/LastTest.log"
          fi
          echo "Tip: for reruns use -R '<pattern>' to focus on problematic suites, e.g.:"
          echo "ctest --test-dir build --output-on-failure --verbose --progress -R '<pattern>'"
