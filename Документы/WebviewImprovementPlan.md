# План улучшений webview/GraphPanel

Цель: поднять UX и надёжность редактора графов в VS Code, не ломая существующую связку React + Cytoscape + Zustand.

## Приоритет 1 — стабильность и контроль данных
- **Валидация протокола сообщений**: описать схему `postMessage` (extension ↔ webview) и валидировать через `zod` или `io-ts`, чтобы ловить неверные payload на границе.
- **Безопасное сохранение/загрузка**: добавить debounce/транзакции при отправке `saveGraph`, логировать ошибки в консоль webview и пробрасывать уведомления обратно в extension.
- **Консистентность состояния**: вынести ключевые операции (`addNode`, `connect`, `delete`) в единый слой действий над Zustand-стором, чтобы Cytoscape/React опирались на одно API.

## Приоритет 2 — UX и эргономика
- **Авто-лейауты**: подключить `cytoscape-klay` или `dagre` для расстановки узлов, добавить кнопку «Рассчитать» и горячую клавишу.
- **Горячие клавиши и контекстное меню**: копировать/вставлять узлы, дублировать связи, удалять `Delete`, отменять `Ctrl+Z/Shift+Ctrl+Z` (history в сторе).
- **Отображение ошибок**: всплывающие уведомления для ошибок валидации/сериализации, подсветка проблемных узлов/портов, фильтр «показать только ошибки».
- **Улучшение стилистики**: вынести тему (цвета портов, толщина рёбер, фон) в конфиг, добавить проверки контраста и подсказки при наведении.

## Приоритет 3 — производительность и тесты
- **Оптимизация рендеринга**: батчить обновления Cytoscape через `cy.batch`, избегать лишних reflow на массовых операциях (drag, zoom).
- **Unit/взаимодействие тесты**: Vitest/Testing Library для Zustand-стора и компонентов панели; Playwright для smoke-теста webview сборки (рендер узла/ребра, сообщение `saveGraph`).
- **Сборка**: разделить чанки (vendor/стор/панель) в webpack для более быстрой загрузки, включить source map только для dev.

## Интеграция с core
- **Валидация схемы графа**: при приёме JSON гонять `GraphSerializer::validate` (если доступно из extension) и подсвечивать нарушения прямо в UI.
- **Версионирование**: хранить версию схемы в сообщениях, при несовместимости показывать подсказку о миграции.

## Что ещё проверить
- Обработка пустых и повреждённых файлов графа.
- Корректное восстановление состояния после перезагрузки webview/VS Code окна.
- Документация: краткий раздел «Работа с webview» в `vscode-extension/README.md` с описанием протокола и команд.

Команды для быстрой проверки (локально):
- `npm run compile` в `vscode-extension` — сборка панели и extension.
- `npm run lint` (после добавления правил) — линт TS/React.
- `npm run test` — юнит-тесты стор/компонентов (после подключения тестового раннера).
