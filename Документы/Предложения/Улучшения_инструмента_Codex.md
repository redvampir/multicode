# Предложения по улучшению инструмента Codex для MultiCode

## Контекст
Ниже — список практичных улучшений с фокусом на стабильность, предсказуемость и снижение нагрузки на ревью.

## Старт реализации (выполнено в текущей итерации)
- [x] **Пункт 1: Единый реестр кодов ошибок**
  - Добавлен `include/visprog/core/ErrorCodes.hpp`.
  - `Graph.cpp` и `GraphSerializer.cpp` переведены на единые коды.
  - Тесты `test_graph.cpp` и `test_graph_serializer.cpp` используют коды из реестра вместо локальных чисел.
- [x] **Пункт 6 (частично): контрактные комментарии для сложных функций**
  - Добавлены контрактные комментарии над `Graph::validate()` и `Graph::remove_node_connections()`.

## 1) Единый реестр кодов ошибок ядра
- Вынести коды ошибок Graph/Node/Serializer в общий заголовок (например, `ErrorCodes.hpp`).
- Добавить короткую таблицу соответствия: код → смысл → модуль.
- Эффект: меньше рассинхронизации между тестами и реализацией.

## 2) “Строгий режим инвариантов” для `Graph::validate()`
- Добавить флаг режима валидации: `Basic`/`Strict`.
- В `Strict` проверять дополнительные инварианты (например, циклы execution-flow, если это требование домена).
- Эффект: гибкость между production-путём и диагностикой в CI.

## 3) Property-based тесты для графа
- Генерировать случайные графы (ограниченные по размеру) и проверять инварианты после серии операций.
- Сценарии: add/remove/connect/disconnect в случайном порядке.
- Эффект: лучшее покрытие edge-case сценариев, которые трудно придумать вручную.

## 4) Снимки (snapshot) внутренних структур графа для отладки
- Добавить диагностическую сериализацию состояния `connections_`, `connection_lookup_`, `adjacency_*`.
- Применять только в тестах или debug-сборке.
- Эффект: ускоряет поиск причин рассинхронизации индексов.

## 5) Метрики качества валидации в CI
- Отчёт по типам найденных ошибок в тестах: broken refs, lookup mismatch, type mismatch.
- Тренд по времени (сколько и каких падений ловится).
- Эффект: видимость деградаций, которые иначе «тонут» в логах.

## 6) Контракты сложных функций в комментариях (по шаблону проекта)
- Для `validate`, `remove_node_connections`, `disconnect` явно фиксировать инварианты и риски.
- Использовать маркеры `INVARIANT:` и `DANGER:` рядом с чувствительными местами.
- Эффект: проще безопасно рефакторить без повторных регрессий.

## 7) Проверка консистентности тестового покрытия по модулям
- Явная матрица: публичный API → тест-кейсы.
- Минимальный порог для критичных модулей (Graph/Serializer).
- Эффект: меньше “слепых зон”, особенно при архитектурных изменениях.

## 8) Автоматическая валидация стиля и сборки перед PR
- Локальный pre-push hook: `clang-format`, сборка, `ctest`.
- Для webview части — аналогичный минимальный набор (`npm run compile`, `npm run lint`, `npm test`).
- Эффект: меньше итераций на исправление базовых ошибок после ревью.

## 9) Набор негативных тестов на “неправильные” данные сериализации
- Дополнить кейсами частично повреждённых JSON-документов и конфликтов типов портов.
- Проверять не только факт ошибки, но и стабильность/понятность диагностики.
- Эффект: надёжнее импорт и миграции графов между версиями.

## 10) Явная политика обратной совместимости формата графа
- Документировать, что считается breaking change.
- Для breaking-изменений — мигратор или dual-read стратегия.
- Эффект: меньше рисков повреждения пользовательских проектов при обновлении.

---

Если нужна, могу следующим шагом превратить этот список в пошаговый roadmap с приоритизацией (P0/P1/P2) и оценкой трудозатрат.

## План реализации оставшегося технического долга

### Объём (что осталось)
- [ ] Пункт 2: строгий режим инвариантов `Graph::validate()`.
- [ ] Пункт 3: property-based тесты для графа.
- [ ] Пункт 4: snapshot-диагностика внутренних структур графа.
- [ ] Пункт 5: метрики качества валидации в CI.
- [ ] Пункт 6 (остаток): контрактные комментарии для `disconnect` и смежных рисковых мест.
- [ ] Пункт 7: матрица покрытия публичного API тестами.
- [ ] Пункт 8: pre-push/pre-PR автоматизация проверок.
- [ ] Пункт 9: дополнительные негативные кейсы сериализации.
- [ ] Пункт 10: политика обратной совместимости формата графа.

### Приоритизация

#### P0 (критично для надёжности ядра)
1. **Строгий режим validate (пункт 2)**
   - Добавить `ValidationMode { Basic, Strict }` в `include/visprog/core/Graph.hpp`.
   - Расширить `Graph::validate()` до `validate(ValidationMode mode = ValidationMode::Basic)`.
   - В `Strict` включить проверку циклов execution-flow и дополнительные structural checks.
   - Обновить `tests/core/test_graph.cpp` сценариями Basic vs Strict.

2. **Негативные тесты сериализации (пункт 9)**
   - Расширить `tests/core/test_graph_serializer.cpp` кейсами:
     - поломанного JSON-формата,
     - конфликтов типа/направления портов,
     - конфликтов дубликатов ID и разрывов ссылок.
   - Проверять не только код ошибки, но и диагностическое сообщение (ключевые подстроки).

3. **Доведение контрактных комментариев (пункт 6, остаток)**
   - Добавить контракт-описания (формат B) над `Graph::disconnect` и критичными участками сериализации.
   - Добавить маркеры `INVARIANT:` возле мест, где поддерживается согласованность `connections_`/`lookup`/`adjacency`.

#### P1 (наблюдаемость и устойчивость процесса)
4. **Snapshot-диагностика (пункт 4)**
   - Добавить debug-only helper (например, `Graph::debug_snapshot()` или тестовый friend-утилити).
   - Формат snapshot: nodes, connections, lookup map, adjacency maps.
   - Использовать snapshot в тестах как дополнение к assert-ам при сложных регрессиях.

5. **Метрики валидации в CI (пункт 5)**
   - Добавить скрипт агрегации ошибок из тестового вывода (тип ошибки/количество/динамика).
   - Публиковать artifact в CI (JSON/Markdown отчёт).
   - Ввести алерт на рост ошибок по категориям.

6. **Автоматизация pre-push/pre-PR (пункт 8)**
   - Добавить `scripts/check_pre_push.sh`:
     - `clang-format` проверка,
     - `cmake --build build -j4`,
     - `ctest --test-dir build --output-on-failure`,
     - `vscode-extension: npm run compile && npm run lint`.
   - Интегрировать через `.githooks` и документацию в `README.md`.

#### P2 (масштабируемость и продуктовая зрелость)
7. **Property-based тесты (пункт 3)**
   - Выбрать библиотеку генеративного тестирования для C++ (или встроенный lightweight-фреймворк).
   - Добавить генератор графов с ограничениями размера/степени узлов.
   - Проверять инварианты после случайных последовательностей операций.

8. **Матрица покрытия API (пункт 7)**
   - Создать документ `Документы/QA/Матрица_покрытия_API.md`.
   - Для каждого публичного метода Graph/Serializer указать тест-кейсы и edge cases.
   - Добавить правило в PR checklist: нельзя добавлять публичный API без записи в матрицу.

9. **Политика обратной совместимости формата (пункт 10)**
   - Создать документ `Документы/Архитектура/Политика_совместимости_формата.md`.
   - Зафиксировать семантику schema-versioning и критерии breaking changes.
   - Описать стратегию dual-read и миграции snapshot-документов.

### Вехи и критерии готовности
- **Веха M1 (P0 завершён):**
  - Strict validate реализован и покрыт тестами.
  - Негативные кейсы сериализации расширены.
  - Контрактные комментарии в ключевых функциях присутствуют.
- **Веха M2 (P1 завершён):**
  - Snapshot-диагностика используется в тестах.
  - CI публикует отчёт по ошибкам валидации.
  - Pre-push checks воспроизводимы локально.
- **Веха M3 (P2 завершён):**
  - Property-based тесты обнаруживают и стабильно воспроизводят регрессии.
  - Матрица покрытия и политика совместимости встроены в процесс изменений.

### Риски и меры снижения
- **Риск:** рост времени прогона CI.
  - **Мера:** разделение быстрых и расширенных проверок (smoke vs nightly).
- **Риск:** ложноположительные падения в property-based тестах.
  - **Мера:** фиксировать seed и печатать минимальный контрпример.
- **Риск:** переусложнение validate в runtime.
  - **Мера:** Basic по умолчанию, Strict для CI/диагностики.
