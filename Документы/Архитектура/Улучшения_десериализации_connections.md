# Улучшения десериализации `connections` в GraphSerializer

## Цель
Снизить хрупкость восстановления графа и упростить сопровождение логики валидации связей.

## Предложения (10 из 10)

1. **Убрать принудительный `force_id_counters` из основного потока десериализации.**
   - Почему: это скрытый глобальный side effect (побочный эффект), который может влиять на следующие операции фабрики в других тестах/сценариях.
   - Как безопасно: восстанавливать порты по сериализованным данным узла либо использовать отдельный локальный контекст ID только для импорта.

2. **Добавить явную валидацию направления портов (`Output -> Input`).**
   - Почему: сейчас проверяется наличие порта, но не его направленность.
   - Эффект: защита от поломанных snapshot-файлов с обратными связями.

3. **Добавить валидацию типа связи (`Execution`/`Data`) и совместимости типов данных портов.**
   - Почему: `graph.connect(...)` выбирает тип по source-порту, но формат JSON уже содержит структуру, которую стоит сверять на границе.
   - Эффект: ошибки становятся детерминированными и диагностируемыми при импорте.

4. **Проверять дубликаты связей до вызова `connect`.**
   - Почему: одинаковые ребра в JSON могут приводить к лишним дублирующим связям.
   - Как: временный `unordered_set` по ключу `{fromNode, fromPort, toNode, toPort}`.

5. **Стабилизировать схему: сделать `connections[].id` обязательным или полностью производным.**
   - Почему: сейчас `id` опционален, что создает неоднозначность при round-trip и отладке.
   - Вариант: либо жестко требовать `id`, либо игнорировать входной `id` и генерировать всегда заново.

6. **Добавить агрегированный режим ошибок валидации (по флагу).**
   - Почему: текущая стратегия fail-fast удобна для runtime, но неудобна для массовой проверки миграций.
   - Эффект: можно получить список всех битых связей в одном прогоне.

7. **Расширить тесты на кейсы несовместимости типов и неправильного направления портов.**
   - Почему: текущие негативные тесты закрывают только несуществующие ID.
   - Минимум: 2 новых теста — `Output->Output` и `StringView->Execution`.

8. **Добавить property-based / fuzz-тесты для JSON-документа графа.**
   - Почему: парсер — типичная точка риска для edge-cases.
   - Эффект: раннее обнаружение падений на странных, но валидных по JSON структурах.

9. **Вынести парсинг `connections` в отдельный приватный helper-модуль.**
   - Почему: `from_json` уже перегружен ответственностями.
   - Эффект: читаемость, изоляция логики, проще поддерживать и тестировать в отрыве от узлов.

10. **Улучшить коды и форматы диагностик для UI/логов.**
    - Почему: `kErrorConnection` общий для множества сценариев; в UI полезно различать `missing_field`, `invalid_ref`, `type_mismatch`.
    - Как: под-коды или структурированная ошибка с категорией + путём JSON (`connections[3].from.portId`).

## Критерии приёмки для следующей итерации
- Нет глобальных побочных эффектов на генерацию ID при десериализации.
- Валидируются направление и типовая совместимость портов.
- Покрыты тестами минимум 4 негативных сценария по `connections`.
- Диагностика содержит путь к проблемному полю JSON.
